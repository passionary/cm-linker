<!DOCTYPE html>
<html>
<head>
	<title>example</title>
	<meta charset="utf-8">
	<style>
		p{
			color: #000;
		}
	</style>
</head>
<body>
	<h1>Hello</h1>
	<template id="temp">		
		<p>some</p>
	</template>
	<script>
		let pointer = 0
		const Dom = {
			create(tag){
				return document.createElement(tag)
			},
			append(parent,node){
				return parent.appendChild(node)
			},
			remove(parent,child){
				parent.removeChild(child)
			},
			update(node,val){
				node.innerHTML = val
			},
			style(node){
				const styles = Array.from(arguments).slice(1)
				const rule = /([^:\s]{3,}):+\s?(\w+)/
				for(let i=0;i<styles.length;i++){			
					const s = styles[i].match(rule)[1]
					const v = styles[i].match(rule)[2]
					if(rule.test(styles[i])) node.style[s] = v			
				}
				return node
			}
		}
		function defineNodes(temp)
		{
			let rules = {
				tag: '(?<=[\\s]*)(?<=\<)[\\w]+',
				cTag: '(?<=\/)[\\w]+',
				inner: '(?<=\{\{\)[\\w]+(?=\}\})'
			}

			let nexts = Array.from(temp.matchAll(/\n/g)).map(i => i.index + 1)
			
			let current = 0

			function next(){			
				current = nexts[pointer++]
			}
			let sopens = Array.from(temp.matchAll(new RegExp(rules.tag,'g')))			
			let scloses = Array.from(temp.matchAll(new RegExp(rules.cTag,'g')))
			if(sopens.length != scloses.length) throw Error('invalid html in template')
			let nodes = []
			let crtag = ''
			let iter = 0
			function back(){
				current = nexts[pointer - 2]
				pointer--
			}
			let inner
			while(current < temp.length && nodes.length != sopens.length){
				iter++
				let str = temp.slice(current,nexts[pointer])
				let tag = str.match(new RegExp(rules.tag))				
				let cTag = str.match(rules.cTag)
				if(tag && tag[0] && !nodes.find(i => i.tag[0] == pointer)){
					crtag = {id:pointer,tag}
					next()
					continue
				}else	if(cTag && crtag && crtag.tag && cTag[0] && crtag.tag[0] && crtag.tag[0] == cTag[0] && !nodes.find(i => i.etag[0] == pointer)){					
					if(inner = temp.slice(nexts[pointer-2],nexts[pointer-1]).match(new RegExp(rules.inner))) {						
						nodes.unshift({tag:[crtag.id,crtag.tag],etag:[pointer,cTag],inner})
					}else{						
						nodes.unshift({tag:[crtag.id,crtag.tag],etag:[pointer,cTag]})
					}
					crtag = 'no'
					next()
					continue
				}else if(crtag === 'no'){
					back()
					continue
				}
				next()
			}
			return nodes
		}
		let ind = 0
		let dom = []		
		let ranges
		let old
		let lvl = ''
		let res = true
		function render(array)
		{
			let i = 0
			let html = Dom.create('div')			
			let buf
			let down = false
			while(i < array.length - 1){				
				let e = array[i]
				let en = array[i+1]

				if(down && buf) {
					if(array[buf][1] - e[1] == 1) {
						e[0].node.appendChild(array[buf][0].node)
						i = buf - 1
						down = false
						i++
						continue
					}

					i--
					continue
				}

				if(en[1] - e[1] == 1){										
					e[0].node = Dom.create(e[0].tag[1][0])
					en[0].node = Dom.create(en[0].tag[1][0])
					e[0].node.appendChild(en[0].node)
					html.appendChild(e[0].node)
					i++
					continue
				}

				if(en[1] - e[1] < 1){
					en[0].node = Dom.create(en[0].tag[1][0])
					buf = i + 1
					down = true
					continue
				}

				i++
			}
			return array
		}
		function makeOutput(array)
		{
			let range = (a,b) => (b.etag[0] - b.tag[0]) - (a.etag[0] - a.tag[0]);
			ranges = array.sort((a,b) => a.tag[0] - b.tag[0])
			recursion(ranges)
			console.log(ranges)
			return defineDom(ranges,dom)
		}
		/* -----Array-----

				[1, 18, 17]   STEPS: 1) nearest: [1, 18, 17] - at the beginning
				[14, 17, 3]					 2) nearest - [2, 6, 4] - at the beginning of max
				[15, 16, 1]					 3) next - [3, 5, 2] - is into nearest
				[7, 13, 6]					 4) next - [7, 13, 6] - out of nearest and after him
				[10, 12, 2]					 5) nearest - [8, 9, 1] - into [7, 13, 6]
				[8, 9, 1]						 6) next - [10, 12, 2] - into [7, 13, 6] after [8, 9, 1]
				[2, 6, 4]						 7) next - [14, 17, 3] - after [7, 13, 6]
				[3, 5, 2]						 8) nearest - [15, 16, 1] - into [14, 17, 3]

			 -----Array-----
		*/	
		function recursion(rangs){
			for(let i=0;i<rangs.length;i++){
				let children = ranges.filter(e => e.tag[0] > rangs[i].tag[0] && e.etag[0] < rangs[i].etag[0])				
				if(children.length){
					let id = ranges.findIndex(e => e == rangs[i])
					dom[id+1] = children.map(e => ranges.findIndex(el => el == e)).join(',')
					recursion(children)
				}
			}			
		}
		function defineDom(ranges,array){
			let DOM = []
			for(let i=0;i<array.length;i++){				
				const count = array.filter(e => new RegExp(`\\b${i}\\b`).test(e)).length
				DOM.push([ranges.find((e,index) => index == i),count])
			}
			return DOM
		}		

		let array = defineNodes(`
			<div l-if="value" -bind="some">
				<h2 l-for="item in elems">					
					<p>	
					<span>
					<span>
					</span>
					</span>			
					</p>
				</h2>
				<select name="" id="">
					<option value="">						
					</option>
					<option value="">
						<p>
							<p>
								<p>
								</p>
							</p>
						</p>
					</option>
					<ul>
						<li>
							<p>
							</p>
						</li>
						<li>
							<p>
							</p>
						</li>
					</ul>
				</select>
				<span l-for="item in elems">
					<span>
					<p>
					</p>
					</span>					
				</span>
				<div>
					<p>
					</p>
				</div>
			</div>
			`)
		console.log(render(makeOutput(array)))
	</script>
<script type="text/javascript" src="../dist/bundle.js"></script>
</body>
</html>